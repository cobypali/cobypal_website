<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventures | Coby Palivathukal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B1220;
            color: #E6EDF7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        a { color: inherit; text-decoration: none; }
        nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(11, 18, 32, 0.95); backdrop-filter: blur(10px);
            padding: 20px 50px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #1A2438;
        }
        .logo { font-size: 24px; font-weight: 700; color: #E6EDF7; letter-spacing: 2px; }
        .nav-links { display: flex; gap: 40px; }
        .nav-links a { font-size: 14px; font-weight: 400; letter-spacing: 1px; text-transform: uppercase; transition: color 0.3s; }
        .nav-links a:hover, .nav-links a.active { color: #3B82F6; }
        main { flex: 1; padding: 100px 50px 40px; }
        .content-section { max-width: 1400px; width: 100%; margin: 0 auto; }
        .page-title { font-size: 48px; font-weight: 600; text-align: center; margin-bottom: 16px; }
        .page-subtitle { text-align: center; color: rgba(230,237,247,0.6); font-size: 16px; margin-bottom: 32px; }
        .channel-link { text-align: center; margin-bottom: 24px; }
        .channel-link a {
            display: inline-flex; align-items: center; gap: 12px;
            background: linear-gradient(135deg, #FF0000, #CC0000); color: white;
            padding: 14px 28px; border-radius: 50px; font-size: 16px; font-weight: 600;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,0,0,0.3);
        }
        .channel-link a:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255,0,0,0.4); }
        .channel-link svg { width: 24px; height: 24px; }
        .globe-hint {
            text-align: center; color: rgba(230,237,247,0.4); font-size: 13px;
            margin-top: 12px; letter-spacing: 0.5px;
        }
        .globe-wrapper {
            position: relative; width: 100%; height: 70vh; min-height: 500px;
            border-radius: 16px; overflow: hidden;
            background: radial-gradient(ellipse at center, #0d1a2d 0%, #0B1220 70%);
        }
        #globe-container { width: 100%; height: 100%; cursor: grab; }
        #globe-container:active { cursor: grabbing; }
        #city-tooltip {
            position: absolute; pointer-events: none; padding: 6px 14px;
            background: rgba(11,18,32,0.9); border: 1px solid rgba(255,68,68,0.5);
            border-radius: 8px; font-size: 13px; font-weight: 500; color: #E6EDF7;
            white-space: nowrap; display: none; z-index: 10;
            backdrop-filter: blur(8px); transform: translate(-50%, -130%);
        }
        #city-tooltip .video-count { color: rgba(230,237,247,0.5); font-size: 11px; margin-left: 6px; }
        .city-label {
            position: absolute; white-space: nowrap; cursor: pointer;
            color: #E6EDF7; font-size: 10px; font-weight: 500; letter-spacing: 0.3px;
            transform: translate(-50%, -100%); padding: 2px 6px; border-radius: 4px;
            text-shadow: 0 0 4px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.7);
            opacity: 0; transition: opacity 0.15s, background 0.15s;
            pointer-events: none;
        }
        .city-label.visible { opacity: 1; pointer-events: auto; }
        .city-label:hover { background: rgba(255,68,68,0.25); }
        /* Loading overlay */
        .globe-loading {
            position: absolute; inset: 0; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(11,18,32,0.85); z-index: 5;
            transition: opacity 0.5s;
        }
        .globe-loading.hidden { opacity: 0; pointer-events: none; }
        .globe-loading .spinner {
            width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.15);
            border-top-color: #3B82F6; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .globe-loading span {
            margin-top: 12px; font-size: 13px; color: rgba(230,237,247,0.5);
            letter-spacing: 0.5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Video Panel */
        #video-panel {
            position: fixed; top: 0; right: 0; width: 420px; height: 100vh;
            background: rgba(11,18,32,0.98); backdrop-filter: blur(20px);
            border-left: 1px solid #1A2438; z-index: 250;
            transform: translateX(100%); transition: transform 0.35s ease;
            display: flex; flex-direction: column;
        }
        #video-panel.active { transform: translateX(0); }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 24px; border-bottom: 1px solid #1A2438; flex-shrink: 0;
        }
        .panel-header h2 { font-size: 22px; font-weight: 600; }
        .panel-header .city-count { font-size: 13px; color: rgba(230,237,247,0.5); margin-top: 4px; }
        #panel-close {
            background: rgba(255,255,255,0.08); border: none; color: #E6EDF7;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        #panel-close:hover { background: rgba(255,68,68,0.3); }
        #panel-video-list { flex: 1; overflow-y: auto; padding: 16px; }
        .video-item {
            display: flex; gap: 12px; padding: 12px; border-radius: 12px;
            transition: background 0.2s; cursor: pointer; margin-bottom: 8px;
        }
        .video-item:hover { background: rgba(255,255,255,0.05); }
        .video-thumb {
            width: 140px; min-width: 140px; aspect-ratio: 16/9;
            border-radius: 8px; overflow: hidden; position: relative;
        }
        .video-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .video-thumb .play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 32px; height: 32px; background: rgba(255,0,0,0.85); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .video-item:hover .play-icon { opacity: 1; }
        .play-icon svg { width: 14px; height: 14px; fill: white; margin-left: 2px; }
        .video-item-info { display: flex; flex-direction: column; justify-content: center; }
        .video-item-title { font-size: 13px; font-weight: 500; line-height: 1.4; color: #E6EDF7; }
        .video-item-date { font-size: 11px; color: rgba(230,237,247,0.45); margin-top: 4px; }
        /* Video Modal */
        .video-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 300; display: none;
            align-items: center; justify-content: center; padding: 40px;
        }
        .video-modal.active { display: flex; }
        .video-modal-content { width: 100%; max-width: 1000px; aspect-ratio: 16/9; position: relative; }
        .video-modal iframe { width: 100%; height: 100%; border: none; border-radius: 12px; }
        .video-modal-close {
            position: absolute; top: -50px; right: 0;
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            font-size: 24px; display: flex; align-items: center; justify-content: center;
        }
        .video-modal-close:hover { background: rgba(255,0,0,0.5); }
        /* Panel overlay for mobile */
        #panel-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 240; display: none;
        }
        #panel-overlay.active { display: block; }
        /* Footer */
        footer { padding: 20px 50px 40px; text-align: center; border-top: 1px solid #1A2438; }
        .social-links-3d { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap; }
        .social-icon-container { width: 100px; height: 100px; cursor: pointer; transition: transform 0.3s; }
        .social-icon-container:hover { transform: scale(1.15); }
        .social-icon-container canvas { width: 100%; height: 100%; }
        .copyright { font-size: 12px; color: rgba(230,237,247,0.5); }
        /* Brain Regions Sidebar */
        #brain-regions-nav {
            position: fixed; top: 80px; right: 20px; background: #121A2B;
            backdrop-filter: blur(20px); padding: 20px; border-radius: 16px;
            color: #E6EDF7; border: 1px solid #1A2438;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 50;
        }
        #brain-regions-nav h3 { margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: rgba(230,237,247,0.5); }
        #brain-regions-nav ul { list-style: none; }
        #brain-regions-nav li a {
            padding: 8px 12px; border-radius: 8px; transition: background 0.2s;
            font-size: 14px; display: flex; align-items: center; gap: 10px;
        }
        #brain-regions-nav li a:hover { background: rgba(59,130,246,0.2); }
        #brain-regions-nav li a.active { background: rgba(59,130,246,0.3); }
        #brain-regions-nav .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        #brain-regions-nav .back-to-brain {
            display: block; text-align: center; background: #3B82F6; color: white;
            padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
            margin-top: 14px; transition: background 0.2s, transform 0.2s;
        }
        #brain-regions-nav .back-to-brain:hover { background: #2563EB; transform: translateY(-1px); }
        @media (max-width: 768px) {
            nav { padding: 15px 20px; }
            .logo { font-size: 20px; }
            .nav-links { gap: 20px; margin-left: 30px; }
            .nav-links a { font-size: 12px; }
            main { padding: 100px 15px 30px; }
            .page-title { font-size: 32px; }
            .globe-wrapper { height: 50vh; min-height: 350px; }
            #video-panel { width: 100%; }
            footer { padding: 20px; }
            .social-links-3d { gap: 20px; margin-left: -25px; }
            .social-icon-container { width: 70px; height: 70px; }
            #brain-regions-nav { display: none; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">COBYPAL</a>
        <div class="nav-links">
            <a href="about.html">About</a>
            <a href="kippystudios.html">Kippy Studios</a>
            <a href="brain.html">Coby's Brain</a>
        </div>
    </nav>
    <div id="brain-regions-nav">
        <h3>Brain Regions</h3>
        <ul>
            <li><a href="adventures.html" class="active"><span class="dot" style="background:#44aaff"></span>Adventures</a></li>
            <li><a href="reading.html"><span class="dot" style="background:#44ff44"></span>Books</a></li>
            <li><a href="filmtv.html"><span class="dot" style="background:#ff4444"></span>Film and TV</a></li>
            <li><a href="food.html"><span class="dot" style="background:#ff8844"></span>Food</a></li>
            <li><a href="games.html"><span class="dot" style="background:#ffaa00"></span>Games and Interactive Media</a></li>
            <li><a href="music.html"><span class="dot" style="background:#ff44ff"></span>Music</a></li>
            <li><a href="principles.html"><span class="dot" style="background:#aa00ff"></span>Principles</a></li>
            <li><a href="protocols.html"><span class="dot" style="background:#00ffaa"></span>Protocols</a></li>
            <li><a href="thoughts.html"><span class="dot" style="background:#00d4ff"></span>Thoughts</a></li>
        </ul>
        <a href="brain.html" class="back-to-brain">Back to Coby's Brain</a>
    </div>
    <main>
        <div class="content-section">
            <h1 class="page-title">Coby's Adventures</h1>
            <p class="page-subtitle">Exploring the world one adventure at a time</p>
            <div class="channel-link">
                <a href="https://www.youtube.com/channel/UCuGQRO3yHpaNdtCoWwkRocA" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                    Subscribe on YouTube
                </a>
            </div>
            <div class="globe-wrapper">
                <div id="globe-container"></div>
                <div id="city-labels"></div>
                <div id="city-tooltip"></div>
                <div class="globe-loading" id="globe-loading">
                    <div class="spinner"></div>
                    <span>Loading adventures&hellip;</span>
                </div>
            </div>
            <p class="globe-hint">Drag to rotate &middot; Scroll to zoom &middot; Click a pin to explore videos</p>
        </div>
    </main>
    <div id="panel-overlay"></div>
    <div id="video-panel">
        <div class="panel-header">
            <div>
                <h2 id="panel-city-name"></h2>
                <div class="city-count" id="panel-city-count"></div>
            </div>
            <button id="panel-close">&times;</button>
        </div>
        <div id="panel-video-list"></div>
    </div>
    <div class="video-modal" id="video-modal">
        <div class="video-modal-content">
            <button class="video-modal-close" id="modal-close">&times;</button>
            <iframe id="video-iframe" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
        </div>
    </div>
    <footer>
        <div class="social-links-3d" id="social-links-3d">
            <div class="social-icon-container" data-link="https://www.youtube.com/user/cobypalivathukal" data-model="socials/youtube_icon/scene.gltf" title="YouTube"></div>
            <div class="social-icon-container" data-link="https://www.instagram.com/cobypal" data-model="socials/instagram_icon/scene.gltf" title="Instagram"></div>
            <div class="social-icon-container" data-link="https://www.tiktok.com/@cobypal?lang=en" data-model="socials/tiktok_icon/scene.gltf" title="TikTok"></div>
            <div class="social-icon-container" data-link="https://www.twitter.com/cobypal" data-model="socials/x_icon/scene.gltf" title="X"></div>
            <div class="social-icon-container" data-link="http://threads.net/@cobypal" data-model="socials/threads_icon/scene.gltf" title="Threads"></div>
            <div class="social-icon-container" data-link="https://www.linkedin.com/in/cobypalivathukal/" data-model="socials/linkedin_icon/scene.gltf" title="LinkedIn"></div>
            <div class="social-icon-container" data-link="https://www.facebook.com/coby.palivathukal" data-model="socials/facebook_icon/scene.gltf" title="Facebook"></div>
        </div>
        <p class="copyright">&copy; 2026 Coby Palivathukal. All rights reserved.</p>
    </footer>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// ── City + Video Data (fetched from Google Sheet) ─────────────────
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1RUCWiT3EF89AuM0xCQvCGW44PJk7YlK7cZfmOXkJRTA/gviz/tq?tqx=out:csv';
let cityData = {};

function parseCSV(text) {
    const rows = [];
    let current = '';
    let inQuotes = false;
    let row = [];
    for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
            if (ch === '"' && text[i + 1] === '"') { current += '"'; i++; }
            else if (ch === '"') { inQuotes = false; }
            else { current += ch; }
        } else {
            if (ch === '"') { inQuotes = true; }
            else if (ch === ',') { row.push(current.trim()); current = ''; }
            else if (ch === '\n' || (ch === '\r' && text[i + 1] === '\n')) {
                row.push(current.trim()); current = '';
                if (row.length > 1) rows.push(row);
                row = [];
                if (ch === '\r') i++;
            } else { current += ch; }
        }
    }
    if (current || row.length) { row.push(current.trim()); if (row.length > 1) rows.push(row); }
    return rows;
}

function extractVideoId(url) {
    if (!url) return null;
    const m = url.match(/(?:youtu\.be\/|[?&]v=)([A-Za-z0-9_-]{11})/);
    return m ? m[1] : null;
}

function processCSVData(rows) {
    // Skip header row (index 0); columns: A=Title, B=Link, C=City, D=State, E=Country, F=Longitude, G=Latitude, H=Publish time
    const cities = {};
    for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        const title = r[0], link = r[1], city = r[2];
        const lng = parseFloat(r[5]), lat = parseFloat(r[6]);
        const publishTime = r[7] || '';
        const id = extractVideoId(link);
        if (!city || !id || isNaN(lat) || isNaN(lng)) continue;
        if (!publishTime || isNaN(new Date(publishTime))) continue;
        if (!cities[city]) cities[city] = { lat, lng, v: [] };
        cities[city].v.push([title, id, publishTime]);
    }
    // Sort each city's videos newest to oldest
    for (const city in cities) {
        cities[city].v.sort((a, b) => {
            const da = new Date(a[2]), db = new Date(b[2]);
            return (isNaN(db) ? 0 : db) - (isNaN(da) ? 0 : da);
        });
    }
    return cities;
}

// ── Three.js Globe Setup ───────────────────────────────────────────
const container = document.getElementById('globe-container');
const tooltip = document.getElementById('city-tooltip');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.01, 1000);
camera.position.set(0, 2, 18);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
container.appendChild(renderer.domElement);

// Controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.06;
controls.rotateSpeed = 0.5;
controls.minDistance = 5.08;
controls.maxDistance = 30;
const AUTO_ROTATE_THRESHOLD = 17; // only auto-rotate when zoomed out past this distance
controls.enablePan = false;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.4;

// Lights
scene.add(new THREE.AmbientLight(0x555570, 1.5));
const sunLight = new THREE.DirectionalLight(0xfff0dd, 1.0);
sunLight.position.set(5, 3, 5);
scene.add(sunLight);

// Globe (loaded from GLB model)
const GLOBE_RADIUS = 5;

// Atmosphere glow
const atmosGeom = new THREE.SphereGeometry(GLOBE_RADIUS * 1.015, 128, 128);
const atmosMat = new THREE.ShaderMaterial({
    vertexShader: `
        varying vec3 vNormal;
        void main(){
            vNormal = normalize(normalMatrix * normal);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
        }
    `,
    fragmentShader: `
        varying vec3 vNormal;
        void main(){
            float intensity = pow(0.65 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 3.0);
            gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity * 0.8;
        }
    `,
    blending: THREE.AdditiveBlending,
    side: THREE.BackSide,
    transparent: true
});
scene.add(new THREE.Mesh(atmosGeom, atmosMat));

// Stars background
const starGeom = new THREE.BufferGeometry();
const starVerts = [];
for (let i = 0; i < 3000; i++) {
    const r = 80 + Math.random() * 120;
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    starVerts.push(r * Math.sin(phi) * Math.cos(theta), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
}
starGeom.setAttribute('position', new THREE.Float32BufferAttribute(starVerts, 3));
scene.add(new THREE.Points(starGeom, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15 })));

// ── Pin Creation ───────────────────────────────────────────────────
function latLngToVec3(lat, lng, radius) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lng + 180) * (Math.PI / 180);
    return new THREE.Vector3(
        -radius * Math.sin(phi) * Math.cos(theta),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
    );
}

const pinGroup = new THREE.Group();
scene.add(pinGroup);
const pinObjs = []; // {mesh, city, ringMesh}

// Create glow texture for rings
function makeRingTexture() {
    const c = document.createElement('canvas');
    c.width = 64; c.height = 64;
    const ctx = c.getContext('2d');
    const grad = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
    grad.addColorStop(0, 'rgba(255,80,40,0.9)');
    grad.addColorStop(0.4, 'rgba(255,40,20,0.4)');
    grad.addColorStop(1, 'rgba(255,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 64, 64);
    return new THREE.CanvasTexture(c);
}
const glowTex = makeRingTexture();

const pinMat = new THREE.MeshBasicMaterial({ color: 0xff4444 });
const pinGeom = new THREE.SphereGeometry(0.04, 10, 10);
const labelsContainer = document.getElementById('city-labels');
labelsContainer.addEventListener('wheel', (e) => {
    e.preventDefault();
    renderer.domElement.dispatchEvent(new WheelEvent('wheel', e));
}, { passive: false });

function createPins(cities) {
    Object.entries(cities).forEach(([city, data]) => {
        const pos = latLngToVec3(data.lat, data.lng, GLOBE_RADIUS + 0.02);
        // Pin dot
        const pin = new THREE.Mesh(pinGeom, pinMat.clone());
        pin.position.copy(pos);
        pin.userData = { city };
        pinGroup.add(pin);

        // Glow ring (sprite)
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({
            map: glowTex, transparent: true, opacity: 0.6, depthWrite: false
        }));
        sprite.position.copy(pos);
        sprite.scale.set(0.35, 0.35, 1);
        pinGroup.add(sprite);

        // HTML label
        const label = document.createElement('div');
        label.className = 'city-label';
        label.textContent = city;
        label.addEventListener('click', (e) => { e.stopPropagation(); openPanel(city); });
        labelsContainer.appendChild(label);

        pinObjs.push({ mesh: pin, sprite, city, pos, label });
    });
}

// ── Raycasting & Interaction ───────────────────────────────────────
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let hoveredPin = null;
let pinScale = 1; // updated each frame based on camera distance

function onPointerMove(e) {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
}
renderer.domElement.addEventListener('pointermove', onPointerMove);

function onPointerDown(e) {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const pins = pinObjs.map(p => p.mesh);
    const hits = raycaster.intersectObjects(pins);
    if (hits.length > 0) {
        const city = hits[0].object.userData.city;
        openPanel(city);
        // Rotate globe to face this city
        const data = cityData[city];
        const target = latLngToVec3(data.lat, data.lng, GLOBE_RADIUS + 5);
        // autoRotate is handled by zoom distance in the animate loop
    }
}
renderer.domElement.addEventListener('pointerdown', onPointerDown);

// Tooltip
function updateTooltip() {
    raycaster.setFromCamera(mouse, camera);
    const pins = pinObjs.map(p => p.mesh);
    const hits = raycaster.intersectObjects(pins);

    if (hits.length > 0) {
        const city = hits[0].object.userData.city;
        const data = cityData[city];
        if (hoveredPin !== city) {
            hoveredPin = city;
            tooltip.innerHTML = city + '<span class="video-count">' + data.v.length + ' video' + (data.v.length !== 1 ? 's' : '') + '</span>';
            tooltip.style.display = 'block';
            pinObjs.forEach(p => {
                p.sprite.material.opacity = p.city === city ? 1.0 : 0.6;
            });
        }
        // Project pin position to screen
        const pos = hits[0].object.position.clone().project(camera);
        const rect = renderer.domElement.getBoundingClientRect();
        tooltip.style.left = ((pos.x + 1) / 2 * rect.width) + 'px';
        tooltip.style.top = ((-pos.y + 1) / 2 * rect.height) + 'px';
        renderer.domElement.style.cursor = 'pointer';
    } else {
        if (hoveredPin) {
            hoveredPin = null;
            tooltip.style.display = 'none';
            pinObjs.forEach(p => {
                p.sprite.material.opacity = 0.6;
            });
            renderer.domElement.style.cursor = 'grab';
        }
    }
}

// ── Video Panel ────────────────────────────────────────────────────
const panel = document.getElementById('video-panel');
const overlay = document.getElementById('panel-overlay');

function openPanel(city) {
    const data = cityData[city];
    document.getElementById('panel-city-name').textContent = city;
    document.getElementById('panel-city-count').textContent = data.v.length + ' video' + (data.v.length !== 1 ? 's' : '');
    const list = document.getElementById('panel-video-list');
    list.innerHTML = data.v.map(([title, id, publishTime]) => {
        let dateStr = '';
        if (publishTime) {
            const d = new Date(publishTime);
            if (!isNaN(d)) dateStr = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        return `
        <div class="video-item" data-id="${id}">
            <div class="video-thumb">
                <img src="https://img.youtube.com/vi/${id}/mqdefault.jpg" alt="${title}" loading="lazy">
                <div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
            </div>
            <div class="video-item-info">
                <div class="video-item-title">${title}</div>
                ${dateStr ? `<div class="video-item-date">${dateStr}</div>` : ''}
            </div>
        </div>`;
    }).join('');
    // Click handlers
    list.querySelectorAll('.video-item').forEach(item => {
        item.addEventListener('click', () => openVideoModal(item.dataset.id));
    });
    panel.classList.add('active');
    overlay.classList.add('active');
}

function closePanel() {
    panel.classList.remove('active');
    overlay.classList.remove('active');
}

document.getElementById('panel-close').addEventListener('click', closePanel);
overlay.addEventListener('click', closePanel);

// ── Video Modal ────────────────────────────────────────────────────
function openVideoModal(videoId) {
    const modal = document.getElementById('video-modal');
    document.getElementById('video-iframe').src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}
function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    document.getElementById('video-iframe').src = '';
    modal.classList.remove('active');
    document.body.style.overflow = '';
}
document.getElementById('modal-close').addEventListener('click', closeVideoModal);
document.getElementById('video-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeVideoModal();
});
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { closeVideoModal(); closePanel(); }
});

// ── Animate ────────────────────────────────────────────────────────
function animate() {
    requestAnimationFrame(animate);
    // Auto-rotate only when fully zoomed out
    const camDist = camera.position.length();
    controls.autoRotate = camDist >= AUTO_ROTATE_THRESHOLD;
    controls.rotateSpeed = 0.5 * Math.pow(camDist / 18, 2);
    controls.update();
    // Scale pins based on zoom distance (cubic for aggressive shrink)
    pinScale = Math.pow(camDist / 18, 3);
    const t = Date.now() * 0.003;
    const camDir = camera.position.clone().normalize();
    const rect = renderer.domElement.getBoundingClientRect();
    // Label font scales inversely with distance so text is readable when close
    const labelFontSize = Math.max(7, Math.min(13, 70 / camDist));
    // First pass: update pin visuals + collect screen positions
    const labelCandidates = [];
    pinObjs.forEach((p, i) => {
        const base = p.city === hoveredPin ? 1.8 * pinScale : pinScale;
        p.mesh.scale.setScalar(base);
        const s = (0.3 + Math.sin(t + i * 0.3) * 0.08) * pinScale;
        if (p.city !== hoveredPin) p.sprite.scale.set(s, s, 1);
        else p.sprite.scale.set(0.35 * pinScale, 0.35 * pinScale, 1);
        const pinDir = p.pos.clone().normalize();
        const facing = camDir.dot(pinDir) > 0.05;
        const projected = p.pos.clone().project(camera);
        if (facing && projected.z < 1) {
            const sx = (projected.x + 1) / 2 * rect.width;
            const sy = (-projected.y + 1) / 2 * rect.height;
            labelCandidates.push({ idx: i, sx, sy, dot: camDir.dot(pinDir) });
        } else {
            p.label.classList.remove('visible');
        }
    });
    // Sort so labels most directly facing camera get placement priority
    labelCandidates.sort((a, b) => b.dot - a.dot);
    // Second pass: place labels with collision avoidance
    const charW = labelFontSize * 0.55;
    const padX = 12;
    const labelH = labelFontSize + 8;
    const gap = 4;
    const aboveY = -(10 * pinScale + 6);
    const belowY = labelH + 6;
    const placed = [];
    for (const lc of labelCandidates) {
        const p = pinObjs[lc.idx];
        const w = p.city.length * charW + padX;
        const attempts = [
            { x: lc.sx, y: lc.sy + aboveY },
            { x: lc.sx, y: lc.sy + belowY },
            { x: lc.sx - w * 0.8, y: lc.sy + aboveY },
            { x: lc.sx + w * 0.8, y: lc.sy + aboveY },
            { x: lc.sx - w * 0.8, y: lc.sy + belowY },
            { x: lc.sx + w * 0.8, y: lc.sy + belowY },
        ];
        let didPlace = false;
        for (const att of attempts) {
            let collides = false;
            for (const pl of placed) {
                if (Math.abs(att.x - pl.x) < (w + pl.w) / 2 + gap && Math.abs(att.y - pl.y) < labelH + gap) {
                    collides = true; break;
                }
            }
            if (!collides) {
                p.label.style.left = att.x + 'px';
                p.label.style.top = att.y + 'px';
                p.label.style.fontSize = labelFontSize + 'px';
                p.label.classList.add('visible');
                placed.push({ x: att.x, y: att.y, w });
                didPlace = true; break;
            }
        }
        if (!didPlace) p.label.classList.remove('visible');
    }
    updateTooltip();
    renderer.render(scene, camera);
}
animate();

// ── Load globe model + spreadsheet data ───────────────────────────
(async () => {
    try {
        const [csvRes, gltf] = await Promise.all([
            fetch(SHEET_CSV_URL),
            new Promise((resolve, reject) => {
                new GLTFLoader().load('3d_models/earth.glb', resolve, undefined, reject);
            })
        ]);
        // Add globe model, scaled to GLOBE_RADIUS
        const model = gltf.scene;
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const scale = (GLOBE_RADIUS * 2) / Math.max(size.x, size.y, size.z);
        model.scale.setScalar(scale);
        model.position.set(-center.x * scale, -center.y * scale, -center.z * scale);
        scene.add(model);
        // Process city data
        const csvText = await csvRes.text();
        const rows = parseCSV(csvText);
        cityData = processCSVData(rows);
        createPins(cityData);
    } catch (err) {
        console.error('Failed to load adventure data:', err);
    } finally {
        const loader = document.getElementById('globe-loading');
        if (loader) loader.classList.add('hidden');
    }
})();

// Resize
window.addEventListener('resize', () => {
    const w = container.clientWidth, h = container.clientHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
});

// ── 3D Social Icons (kept from original) ───────────────────────────
const socialIcons = document.querySelectorAll('.social-icon-container');
const socialScenes = [];
socialIcons.forEach((iconContainer) => {
    const modelPath = iconContainer.dataset.model;
    const link = iconContainer.dataset.link;
    const iconScene = new THREE.Scene();
    const iconCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
    const iconRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    iconRenderer.setSize(100, 100);
    iconRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    iconContainer.appendChild(iconRenderer.domElement);
    iconCamera.position.set(0, 0, 3);
    iconScene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const iconKey = new THREE.DirectionalLight(0xffffff, 1.2);
    iconKey.position.set(2, 2, 2);
    iconScene.add(iconKey);
    const iconLoader = new GLTFLoader();
    iconLoader.load(modelPath, (gltf) => {
        const m = gltf.scene;
        const box = new THREE.Box3().setFromObject(m);
        const size = box.getSize(new THREE.Vector3());
        m.scale.setScalar(1.8 / Math.max(size.x, size.y, size.z));
        const sBox = new THREE.Box3().setFromObject(m);
        const c = sBox.getCenter(new THREE.Vector3());
        m.position.set(-c.x, -c.y, -c.z);
        const pivot = new THREE.Group();
        pivot.add(m);
        iconScene.add(pivot);
        iconContainer._pivot = pivot;
        iconContainer._manualRotation = 0;
        iconContainer._isDragging = false;
        iconContainer._hasDragged = false;
        iconContainer._lastX = 0;
    });
    socialScenes.push({ scene: iconScene, camera: iconCamera, renderer: iconRenderer });
    const onDragStart = (cx) => { iconContainer._isDragging = true; iconContainer._hasDragged = false; iconContainer._lastX = cx; };
    const onDragMove = (cx) => {
        if (iconContainer._isDragging && iconContainer._pivot) {
            const d = cx - iconContainer._lastX;
            if (Math.abs(d) > 2) iconContainer._hasDragged = true;
            iconContainer._manualRotation += d * 0.02;
            iconContainer._lastX = cx;
        }
    };
    const onDragEnd = () => { iconContainer._isDragging = false; };
    iconContainer.addEventListener('mousedown', (e) => { e.preventDefault(); onDragStart(e.clientX); });
    window.addEventListener('mousemove', (e) => { onDragMove(e.clientX); });
    window.addEventListener('mouseup', onDragEnd);
    iconContainer.addEventListener('touchstart', (e) => { onDragStart(e.touches[0].clientX); }, { passive: true });
    window.addEventListener('touchmove', (e) => { if (iconContainer._isDragging) onDragMove(e.touches[0].clientX); }, { passive: true });
    window.addEventListener('touchend', onDragEnd);
    iconContainer.addEventListener('click', () => { if (!iconContainer._hasDragged) window.open(link, '_blank'); });
});
function animateSocialIcons() {
    requestAnimationFrame(animateSocialIcons);
    const time = Date.now() * 0.001;
    socialIcons.forEach((ic, i) => {
        const p = ic._pivot;
        if (p) {
            if (ic._isDragging) { p.rotation.y = ic._manualRotation; }
            else { const a = time + i * 0.5; ic._manualRotation = a; p.rotation.y = a; }
        }
    });
    socialScenes.forEach((item) => { item.renderer.render(item.scene, item.camera); });
}
animateSocialIcons();
    </script>
</body>
</html>
